<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>SAT/MFE API</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,700,1,0" />
        <style>
            .logs {
                font-family: 'Courier New', Courier, monospace;
                font-size: small;
            }

            body {
                background-color: #336699;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <br><br>
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8">
                    <h1 style="color: #fff">Módulo Fiscal Eletronico SAT/MFE</h1>
                    <div class="alert alert-info" role="alert">
                        <strong>Aten&ccedil;&atilde;o!</strong> Para que a API possa carregar as DLLs do m&oacute;dulo fiscal, a vers&atilde;o do java instalado na m&aacute;quina que executa a API precisa ser 32bit.
                    </div>
                </div>
                <div class="col-md-2"></div>
            </div>
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8 alert alert-danger" role="alert" id="msgInfo"></div>
                <div class="col-md-8" id="info">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Informações do Módulo</h5>
                            <table class="table">
                                <tr>
                                    <td><b>Número de Série</b></td>
                                    <td><span id="nserie"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Tipo de LAN</b></td>
                                    <td><span id="tipoLan"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Endereço IP da Lan</b></td>
                                    <td><span id="lanIP"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Endereço MAC</b></td>
                                    <td><span id="lanMac"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Máscara de sub-rede</b></td>
                                    <td><span id="lanMasc"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Endereço gateway</b></td>
                                    <td><span id="lanGw"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Endereço DNS1</b></td>
                                    <td><span id="lanDns1"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Endereço DNS2</b></td>
                                    <td><span id="lanDns2"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Status da rede</b></td>
                                    <td><span id="statusLan"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Nível da bateria</b></td>
                                    <td><span id="nivelBateria"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Memória de Trabalho Total</b></td>
                                    <td><span id="mtTotal"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Memória de Trabalho Usada</b></td>
                                    <td><span id="mtUsada"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Data e hora atual</b></td>
                                    <td><span id="dhAtual"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Versão do Software</b></td>
                                    <td><span id="verSb"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Versão do Leiaute da tabela de informações</b></td>
                                    <td><span id="verLayout"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Número sequencial do Último CF-e-SAT Emitido</b></td>
                                    <td><span id="ultimoCFeSat"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Número sequencial do primeiro CF-e SAT</b></td>
                                    <td><span id="listaInicial"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Número sequencial do último CF-e-SAT</b></td>
                                    <td><span id="listaFinal"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Data e hora da última transmissão de CF-e SAT para SEFAZ</b></td>
                                    <td><span id="dhCfe"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Última comunicação com a SEFAZ</b></td>
                                    <td><span id="dhUltima"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Data de emissão do certificado instalado</b></td>
                                    <td><span id="certEmissao"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Data de vencimento do certificado instalado</b></td>
                                    <td><span id="certVencimento"></span></td>
                                </tr>
                                <tr>
                                    <td><b>Estado de Operação do SAT</b></td>
                                    <td><span id="estadoOperacao"></span></td>
                                </tr>
                            </table>
                            <div class="position-relative">
                                <button id="btAtualizar" class="btn btn-secondary">Atualizar</button>
                            </div>
                        </div>
                    </div>

                    <br/>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Log</h5>
                            <textarea wrap="off" class="form-control logs" id="logs" rows = "10"></textarea>
                            <br/>
                            <div class="position-relative">
                                <button id="btExtrairLogs" class="btn btn-secondary">Obter Logs</button>
                            </div>
                        </div>
                    </div>

                    

                </div>
                <div class="col-md-2"></div>
            </div>
            <br />
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Configurações</h5>
                            <div class="alert alert-danger" role="alert" id="msg"></div>
                            <input type="hidden" id="id" name="id" />
                            <div class="form-checkbox">
                                <input type="checkbox" id="logAtivado"/>
                                <label for="logAtivado" class="col-sm-3 col-form-label">Log ativado</label>
                            </div>
                            <div class="row mb-3">
                                <label for="codigoAtivacao" class="col-sm-3 col-form-label">Codigo Ativação</label>
                                <div class="col-sm-9">
                                    <input type="password" id="codigoAtivacao" class="form-control"/>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="libsDir" class="col-sm-3 col-form-label">Diretório DLL</label>
                                <div class="col-sm-9">
                                    <input type="text" id="libsDir" class="form-control"/>
                                </div>
                            </div>
                            <button id="btSalvar" class="btn btn-primary">Salvar Configura&ccedil;&otilde;es</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-2"></div>
            </div>
        </div>
        <br /><br /><br />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
        <script type="text/javascript">
            
            $(document).ready(function(){

                // versao inicio
                $.ajax({
                    url: 'versao',
                    method: 'get',
                    statusCode: {
                        404: function() {
                            alert( "page not found" );
                        }
                    }
                }).done(function (data){
                    $(document).attr('title', 'SAT/MFE API - v' + data);
                });
                // versao fim

                $("#msg").hide()
                $("#info").hide()
                $("#msgInfo").hide()

                $.ajax({
                    url: 'config',
                    method: 'get',
                    statusCode: {
                        404: function() {
                            alert( "page not found" );
                        }
                    }
                }).done(function (data){
                    $("#id").val(data.id)
                    $("#codigoAtivacao").val(data.codigoAtivacao)
                    $("#libsDir").val(data.libsDir)
                    $("#logAtivado").prop("checked", data.logAtivado);
                });

                $("#btSalvar").click(function(){

                    $("#btSalvar").prop("disabled", true)
                    $("#msg").hide()

                    var _id = $("#id").val()
                    var _codigoAtivacao = $("#codigoAtivacao").val()
                    var _lbsDir = $("#libsDir").val()
                    var _logAtivado = $("#logAtivado").is(":checked")

                    if (_id !== "" && _codigoAtivacao !== "" && _lbsDir !== "") {

                        $.ajax({
                            url: 'config',
                            method: 'post',
                            dataType: 'json',
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify({
                                id: _id,
                                codigoAtivacao: _codigoAtivacao, 
                                libsDir: _lbsDir,
                                logAtivado: _logAtivado
                            }),
                            statusCode: {
                                200: function() {
                                    $("#msg").html("Alteração realizada com sucesso!")
                                    $("#msg").attr("class", "alert alert-success")
                                    $("#msg").show()
                                    obterStatusOperacional();
                                }
                            }
                        }).done(function (data){
                            $("#btSalvar").prop("disabled", false)
                            $("#id").val(data.id)
                            $("#codigoAtivacao").val(data.codigoAtivacao)
                            $("#libsDir").val(data.libsDir)
                            $("#logAtivado").prop("checked", data.logAtivado);
                        });
                    } else {
                        $("#msg").html("Todas as informações são necessárias")
                        $("#msg").attr("class", "alert alert-danger")
                        $("#msg").show()
                    }
                });

                obterStatusOperacional();

                function obterStatusOperacional() {
                    $("#btAtualizar").prop("disabled", true)
                    $.ajax({
                        url: 'consultar-status-operacional',
                        method: 'post',
                        statusCode: {
                            404: function(data) {
                                $("#msgInfo").html(data.message)
                                $("#msgInfo").show()
                                $("#info").hide()
                            },
                            400: function(data) {
                            }
                        },
                        error: function(xhr, status, error) {
                            var err = JSON.parse(xhr.responseText);
                            $("#msgInfo").html(err.message)
                            $("#msgInfo").show()
                            $("#info").hide()
                        }
                    }).done(function (data){
                        $("#btAtualizar").prop("disabled", false)

                        $("#info").show()
                        $("#msgInfo").hide()
                        $("#nserie").html(data.conteudoRetorno.nserie);//: "900017838",
                        $("#tipoLan").html(data.conteudoRetorno.tipoLan);//: "DHCP",
                        $("#lanIP").html(data.conteudoRetorno.lanIP);//: "000.000.000.000",
                        $("#lanMac").html(data.conteudoRetorno.lanMac);//: "00:23:dd:00:45:ae",
                        $("#lanMasc").html(data.conteudoRetorno.lanMasc);//: "000.000.000.000",
                        $("#lanGw").html(data.conteudoRetorno.lanGw);//: "000.000.000.000",
                        $("#lanDns1").html(data.conteudoRetorno.lanDns1);//: "000.000.000.000",
                        $("#lanDns2").html(data.conteudoRetorno.lanDns2);//: "000.000.000.000",
                        $("#statusLan").html(data.conteudoRetorno.statusLan);//: "DESCONECTADO",
                        $("#nivelBateria").html(data.conteudoRetorno.nivelBateria);//: "ALTO",
                        $("#mtTotal").html(data.conteudoRetorno.mtTotal);//: "2.58 Gbyte",
                        $("#mtUsada").html(data.conteudoRetorno.mtUsada);//: "167 Mbytes",
                        $("#dhAtual").html(data.conteudoRetorno.dhAtual);//: "20221008080429",
                        $("#verSb").html(data.conteudoRetorno.verSb);//: "02.00.22",
                        $("#verLayout").html(data.conteudoRetorno.verLayout);//: "00.07",
                        $("#ultimoCFeSat").html(data.conteudoRetorno.ultimoCFeSat);//: "23221014200166000166599000178380001150192281",
                        $("#listaInicial").html(data.conteudoRetorno.listaInicial);//: "23220814200166000166599000178380000122339239",
                        $("#listaFinal").html(data.conteudoRetorno.listaFinal);//: "23221014200166000166599000178380001150192281",
                        $("#dhCfe").html(data.conteudoRetorno.dhCfe);//: "20220809184012",
                        $("#dhUltima").html(data.conteudoRetorno.dhUltima);//: "20220809211934",
                        $("#certEmissao").html(data.conteudoRetorno.certEmissao);//: "20220808",
                        $("#certVencimento").html(data.conteudoRetorno.certVencimento);//: "20240729",
                        $("#estadoOperacao").html(data.conteudoRetorno.estadoOperacao);//: "DESBLOQUEADO"

                    });
                }

                $("#btAtualizar").click(function(){
                    obterStatusOperacional();
                });

                $("#btExtrairLogs").click(function(){
                    textareaa = document.getElementById("logs")
                    textareaa.value = "Aguarde..."
                    $("#btExtrairLogs").prop("disabled", true)
                    $.ajax({
                        url: 'extrair-logs',
                        method: 'post'
                    }).done(function (data){
                        $("#btExtrairLogs").prop("disabled", false)
                        if (data.mensagemSEFAZ !== null) {
                            decoded = atob(data.mensagemSEFAZ)

                            textareaa.value = decoded

                            const end = textareaa.value.length;
                            textareaa.setSelectionRange(end, end);
                            textareaa.focus();
                        } else {
                            textareaa.value = "Tente novamente"
                        }

                    });
                })
            });
            
        </script>
    </body>
</html>